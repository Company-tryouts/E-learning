{% extends "base.html" %}

{% block content %}
<div id="chat">
  <!-- chat messages will go here -->
</div>
<input id="chat-message-input" type="text" placeholder="Type message..." />
<button id="chat-message-submit">Send</button>
{% endblock %}

{% block domready %}
<script>
console.log("chat script loaded");

var url = 'wss://' + window.location.host + '/ws/chat/room/' + '{{ course.id }}/';
window.chatSocket = new WebSocket(url);

chatSocket.onmessage = function(e) {
  var data = JSON.parse(e.data);
  var message = data.message;
  var dateOptions = {hour: 'numeric', minute: 'numeric', hour12: true};
  var datetime = new Date(data['datetime']).toLocaleString('en', dateOptions);
  var isMe = data.user === '{{ request.user.username }}';
  var source = isMe ? 'me' : 'other';
  var name = isMe ? 'Me' : data.user;
  var $chat = $('#chat');
  $chat.append('<div class="' + source + '"><strong>' + name + '</strong> (' + datetime + ')<br>' + message + '</div>');
  $chat.scrollTop($chat[0].scrollHeight);
};

chatSocket.onclose = function(e) {
  console.error('Chat socket closed unexpectedly');
};

var $input = $('#chat-message-input');
var $submit = $('#chat-message-submit');

$submit.click(function() {
  var message = $input.val();
  if (message) {
    chatSocket.send(JSON.stringify({'message': message}));
    $input.val('');
    $input.focus();
  }
});

$input.focus();
$input.keyup(function(e) {
  if (e.which === 13) {
    $submit.click();
  }
});
</script>
{% endblock %}
